// CTAD Protocol - Creation-Time Authorship Declaration
//
// This schema implements append-only authorship declarations.
// Declarations record claims, not verification.
// Revisions are append-only - original declarations are never overwritten.

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Work: The creative artifact being declared
// A Work can have exactly one Declaration, but multiple Revisions
model Work {
  id          String       @id @default(cuid())
  title       String
  createdAt   DateTime     @default(now())
  declaration Declaration?
}

// Declaration: The original creation-time authorship claim
// This is immutable - changes are tracked via DeclarationRevision
model Declaration {
  id           String                @id @default(cuid())
  workId       String                @unique
  createdAt    DateTime              @default(now())

  // REQUIRED: Statement of creative intent
  // What was the creator trying to achieve?
  intent       String                @db.Text

  // REQUIRED: Tools used in creation
  // List of software, hardware, instruments, AI systems, etc.
  tools        String                @db.Text

  // Was AI used in any part of the creation process?
  aiUsed       Boolean               @default(false)

  // Optional: Other contributors to the work
  contributors String?               @db.Text

  work         Work                  @relation(fields: [workId], references: [id], onDelete: Cascade)
  revisions    DeclarationRevision[]
  audioRefs    AudioReference[]
  processDeclaration ProcessDeclaration? // Optional link to process capture data
}

// AudioReference: Hash-based reference to audio files
// We store the SHA-256 hash of the audio file, NOT the file itself.
// This provides a cryptographic link between declaration and audio
// without embedding metadata into the audio file.
model AudioReference {
  id            String      @id @default(cuid())
  declarationId String
  createdAt     DateTime    @default(now())

  // Original filename for display purposes
  fileName      String

  // SHA-256 hash of the audio file contents
  // This is the cryptographic fingerprint linking declaration to audio
  sha256        String

  // Optional description of this audio reference
  description   String?     @db.Text

  declaration   Declaration @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  @@index([declarationId])
  @@index([sha256])
}

// DeclarationRevision: Append-only amendments to a declaration
// Each revision captures a point-in-time update without overwriting history
model DeclarationRevision {
  id            String      @id @default(cuid())
  declarationId String
  createdAt     DateTime    @default(now())

  // REQUIRED: Why is this revision being made?
  changeNote    String      @db.Text

  // Updated fields (all optional - only include what changed)
  intent        String?     @db.Text
  tools         String?     @db.Text
  aiUsed        Boolean?
  contributors  String?     @db.Text

  declaration   Declaration @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  @@index([declarationId])
}

// ============================================================================
// PROCESS CAPTURE - Refyn Integration for RLHF Training Data
// ============================================================================

// AIPlatform: Supported AI generation platforms
enum AIPlatform {
  MIDJOURNEY
  SUNO
  UDIO
  RUNWAY
  PIKA
  DALLE
  FLUX
  LEONARDO
  STABLE_DIFFUSION
  HIGGSFIELD
  CHATGPT
  CLAUDE
  UNKNOWN
}

// ContributorTier: Reward tier levels based on contribution points
enum ContributorTier {
  EXPLORER    // 0-99 points
  CURATOR     // 100-499 points
  TASTEMAKER  // 500-1999 points
  ORACLE      // 2000+ points
}

// ProcessDeclaration: Captures the creative process behind a work
// Records prompt iterations, rejections, and final selections
// This data is valuable for RLHF training
model ProcessDeclaration {
  id                String       @id @default(cuid())
  declarationId     String?      @unique // Optional link to final Declaration
  createdAt         DateTime     @default(now())

  // Platform and session info
  platform          AIPlatform
  sessionStartedAt  DateTime
  sessionEndedAt    DateTime?
  sessionDuration   Int?         // Duration in seconds
  iterationCount    Int          @default(0)

  // Process data stored as JSON for flexibility
  // PromptVersion[]: { id, content, timestamp, parentId, mode, platform, metadata }
  promptLineage     Json

  // RejectedOutput[]: { id, promptVersionId, timestamp, reason, customFeedback }
  rejectedOutputs   Json

  // SelectedOutput: { id, promptVersionId, timestamp, likeReason, customFeedback }
  selectedOutput    Json?

  // Consent fields - required for data usage compliance
  consentForTrainingData  Boolean   @default(false)
  consentTimestamp        DateTime?
  consentVersion          String?   // e.g., "1.0" - tracks consent UI version

  // Contributor info (anonymous)
  contributorId           String?   // Anonymous hash identifier
  contributorTasteScore   Float?    // Calculated from selection alignment (0-1)
  contributorExpertiseTags String[] // e.g., ["electronic", "cinematic"]

  // Optional relation to Declaration (if final work was declared)
  declaration       Declaration? @relation(fields: [declarationId], references: [id])

  @@index([contributorId])
  @@index([platform])
  @@index([createdAt])
  @@index([consentForTrainingData])
}

// Contributor: Tracks anonymous contributor statistics and rewards
// Used to calculate quality multipliers and manage tier progression
model Contributor {
  id                String          @id @default(cuid())
  anonymousId       String          @unique // Browser fingerprint hash
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Contribution stats
  totalContributions Int            @default(0)
  totalPoints        Int            @default(0)
  currentTier        ContributorTier @default(EXPLORER)

  // Quality signals
  tasteScore         Float          @default(0.5) // 0-1, alignment with consensus
  expertiseTags      String[]       // Accumulated expertise areas

  // Platform-specific stats stored as JSON
  // { platform: { contributions: number, accuracy: number } }
  platformStats      Json?

  // Consent tracking
  consentVersion     String?
  consentTimestamp   DateTime?

  @@index([anonymousId])
  @@index([currentTier])
  @@index([tasteScore])
}
